<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <record model="ir.ui.view" id="inherit_crm">
        <field name="name">crm.lead.form.inherit</field>
        <field name="model">crm.lead</field>
        <field name="inherit_id" ref="crm.crm_lead_view_form"/>
        <field name="arch" type="xml">
            <xpath expr="//button[@name='action_set_lost']" position="after">
                <field name="is_cost_sheet_generated" invisible="1"/>
                <button name="generate_cost_sheet" string="Create Cost Sheet" type="object"
                        attrs="{'invisible': ['|',('is_cost_sheet_generated','!=',False),('type', '!=', 'opportunity')]}"
                        groups="cost_sheet_quotations.group_costsheet_user_own"/>

                <button name="open_cost_sheet" string="Open Cost Sheet" type="object"
                        attrs="{'invisible': ['|',('is_cost_sheet_generated','=',False),('type', '!=', 'opportunity')]}"
                        groups="cost_sheet_quotations.group_costsheet_user_all,cost_sheet_quotations.group_costsheet_user_own,cost_sheet_quotations.group_costsheet_user_manager"/>

            </xpath>

        </field>
    </record>
    <record id="action_costsheet_quotation" model="ir.actions.act_window">
        <field name="name">Sales Orders</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">sale.order</field>
        <field name="view_mode">tree,kanban,form,calendar,pivot,graph,activity</field>
        <field name="search_view_id" ref="sale.sale_order_view_search_inherit_sale"/>
        <field name="domain">[('cost_sheet_id', '=', active_id)]</field>
        <field name="context">{'search_default_cost_sheet_id': active_id, 'default_cost_sheet_id': active_id}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Create a new quotation, the first step of a new sale!
            </p>
            <p>
                Once the quotation is confirmed, it becomes a sales order.
                <br/>
                You will be able to create an invoice and collect the payment.
            </p>
        </field>
    </record>


    <record model="ir.ui.view" id="assesst_view inheritsx">
        <field name="name">account.asset.crm.form</field>
        <field name="model">account.asset</field>
        <field name="inherit_id" ref="account_asset.view_account_asset_form"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='original_value']" position="after">
                <field name="cry"/>
            </xpath>


        </field>
    </record>


    <record model="ir.ui.view" id="costsheet_form">
        <field name="name">cost.sheet.crm.form</field>
        <field name="model">cost.sheet.crm</field>
        <field name="arch" type="xml">
            <form class="o_lead_opportunity_form">
                <header>
                    <field name="is_quotation_generated" invisible="1"/>
                    <button name="create_quotation" attrs="{'invisible': [('is_quotation_generated','!=',False)]}"
                            class="btn-primary" string="Create Quotation" type="object">

                    </button>

                    <button name="create_additional_cost_sheet"
                            class="btn-primary" string="Create Additional Costsheet" type="object"/>


                    <button name="approve_cs"
                            class="btn-primary" string="Approve" type="object"
                            groups="cost_sheet_quotations.group_costsheet_user_manager"
                            attrs="{'invisible': [('state','in',['Approved','Draft'])]}"
                    />


                    <button name="validate_cs"
                            class="btn-primary" string="Validate" type="object"
                            attrs="{'invisible': [('state','in',['Validated','Approved'])]}"
                            groups="cost_sheet_quotations.group_costsheet_user_all"
                    />

                    <button name="reset_todraft"
                            string="Reset to Draft" type="object"
                            attrs="{'invisible': [('state','in',['Draft'])]}"
                            groups="cost_sheet_quotations.group_costsheet_user_all"/>

                    <!--                    <div class="oe_button_box" align="right">-->

                    <!--                    </div>-->


                    <field name="state" widget="statusbar" statusbar_visible="Draft,Validated,Approved"/>


                </header>

                <sheet>

                    <div class="oe_button_box" align="right">
                        <button name="final_total_cal" class="btn btn-primary oe_left"
                                string="Compute" type="object"/>
                    </div>


                    <div class="oe_button_box" name="button_box">
                        <button class="oe_stat_button"
                                context="{'default_cost_sheet_id': id}"
                                name="%(cost_sheet_quotations.action_costsheet_quotation)d" type="action"
                                icon="fa-pencil-square-o">
                            <div class="o_stat_info">
                                <field name="quotation_count" widget="statinfo" string="Quotations"/>
                            </div>
                        </button>
                    </div>
                    <field name="company_currency" invisible="1" force_save="1"/>
                    <separator style="color:black;font-weight:bold;font-size:28px;" string="Cost Sheet"
                               colspan="4"></separator>
                    <group col="4" colspan="12">
                        <field name="name" readonly="1" force_save="1"/>
                        <field name="opportunity_id" readonly="1" force_save="1"/>
                        <field name="cost_sheet_date" required="1"/>
                        <field name="client"/>
                        <field name="sale_person"/>
                    </group>

                    <group col="4" colspan="12">
                        <field name="is_final_cs" groups="cost_sheet_quotations.group_costsheet_user_manager"/>
                        <field name="dafult_cost_sheet_ref"></field>
                        <field name="closing_estimation_target"></field>

                    </group>

                    <group col="2" colspan="6">
                        <field name="grand_total" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                        <field name="markup_type"/>
                        <field name="markup_value"/>
                        <field name="quotation_value" widget="monetary"
                               options="{'currency_field': 'company_currency'}"/>
                    </group>

                    <group col="4" colspan="12">

                        <field name="material_total" widget="monetary"
                               options="{'currency_field': 'company_currency'}"/>
                        <field name="labor_total" widget="monetary" options="{'currency_field': 'company_currency'}"/>
                        <field name="overhead_total" widget="monetary"
                               options="{'currency_field': 'company_currency'}"/>
                        <field name="rental_total" widget="monetary" options="{'currency_field': 'company_currency'}"/>

                        <field name="rental_total_out" widget="monetary"
                               options="{'currency_field': 'company_currency'}"/>

                    </group>

                    <notebook>

                        <page string="Scope of Work">
                            <field name="scope_work" force_save="1">
                                <tree editable="bottom">
                                    <field name="product_id" domain="[('final_prod','=',True)]"
                                           options="{'no_create': True, 'no_open': True}"/>
<!--                                    <field name="desc"/>-->
                                    <!--                                    <field name="uom"/>-->
                                    <!--                                    <field name="rate"/>-->
                                    <field name="total_qty"/>
                                    <field name="total_cost" readonly="1"/>
                                </tree>
                            </field>
                        </page>


                        <page string="Materials">
                            <field name="material_ids" context="{'scope':scope_work}" force_save="1">
                                <tree editable="bottom">
                                    <field name="product_final" domain="[('final_prod','=',True)]"
                                           widget="many2many_list" options="{'no_create': True, 'no_open': True}"/>
                                    <field name="product_id" domain="[('raw_mat','=',True)]"
                                           options="{'no_create': True, 'no_open': True}"/>

                                    <field name="is_last" invisible="1"/>
                                    <field name="qty_ava"/>
                                    <field name="qty"/>

                                    <!--                                    <field name="days"/>-->
                                    <!--                                    <field name="hours"/>-->

                                    <field name="uom"/>
                                    <field name="rate" readonly="1" force_save="1"/>
                                    <field name="subtotal"/>
                                </tree>
                            </field>


                        </page>
                        <page string="Direct Labours">
                            <field name="labor_ids" context="{'scope':scope_work}" force_save="1">
                                <tree editable="bottom">
                                    <field name="product_final" force_save="1" domain="[('final_prod','=',True)]"
                                           options="{'no_create': True, 'no_open': True}"/>
                                    <!--                                    <field name="product_id" force_save="1"  options="{'no_create': True, 'no_open': True}"/>-->
                                    <field name="department" force_save="1"
                                           options="{'no_create': True, 'no_open': True}"/>
                                    <field name="job_id" force_save="1" options="{'no_create': True, 'no_open': True}"
                                           domain="[('department_id','=',department)]"/>
                                    <field name="grade" force_save="1" options="{'no_create': True, 'no_open': True}"
                                           required="True"/>

                                    <field name="qty"/>
                                    <field name="uom"/>

                                    <!--                                    <field name="days"/>-->
                                    <field name="hours" force_save="1"/>
                                    <!--                                    <field name="rate"/>-->
                                    <field name="subtotal"/>
                                </tree>
                            </field>


                        </page>
                        <page string="Overheads">
                            <field name="overhead_ids" context="{'scope':scope_work}" force_save="1">
                                <tree editable="bottom">
                                    <field name="product_final" domain="[('final_prod','=',True)]"
                                           options="{'no_create': True, 'no_open': True}"/>
                                    <field name="product_id" domain="[('overhead_mat','=',True)]"
                                           options="{'no_create': True, 'no_open': True}"/>
                                    <field name="qty"/>
                                    <field name="uom"/>
                                    <field name="rate" readonly="1" force_save="1"/>

                                    <field name="subtotal"/>
                                </tree>
                            </field>


                        </page>
                        <page string="Rental Internal">
                            <field name="internal_rental_ids" context="{'scope':scope_work}" force_save="1">
                                <tree editable="bottom">
                                    <field name="product_final" domain="[('final_prod','=',True)]"
                                           options="{'no_create': True, 'no_open': True}"/>

                                    <field name="product_id" options="{'no_create': True, 'no_open': True}"/>
                                    <field name="qty"/>
                                    <field name="uom"/>
                                    <field name="rate"/>

                                    <field name="subtotal"/>
                                </tree>
                            </field>


                        </page>

                        <page string="Rental Outsource">
                            <field name="outsource_rental_ids" context="{'scope':scope_work}" force_save="1">
                                <tree editable="bottom">
                                    <field name="product_final" domain="[('final_prod','=',True)]"
                                           options="{'no_create': True, 'no_open': True}"/>

                                    <field name="product_id" domain="[('overhead_mat','=',True)]"
                                           options="{'no_create': True, 'no_open': True}"/>
                                    <field name="qty"/>
                                    <field name="uom"/>
                                    <field name="rate" readonly="1" force_save="1"/>

                                    <field name="subtotal"/>
                                </tree>
                            </field>

                        </page>


                        <page string="Summery" invisible="1">

                            <group>
                                <!--                                <field name="initial_budget"/>-->
                                <!--                                <field name="cs_history_value"/>-->
                                <!--                                <field name="auctual_budget"/>-->
                                <!--                                <field name="quotation_value"/>-->
                                <!--                                <field name="final_profit"/>-->
                            </group>

                        </page>


                    </notebook>
                </sheet>

                <div class="oe_chatter">
                    <field name="message_follower_ids" widget="mail_followers"/>
                    <field name="activity_ids" widget="mail_activity"/>
                    <field name="message_ids" widget="mail_thread"/>
                </div>
            </form>
        </field>
    </record>


</odoo>
